<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1400" width="1000" height="1400">
  <defs>
    <!-- Gradients -->
    <linearGradient id="actionGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f093fb;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f5576c;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="parallelGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#11998e;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#38ef7d;stop-opacity:1" />
    </linearGradient>
    
    <!-- Shadow -->
    <filter id="shadow" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-color="#000" flood-opacity="0.15"/>
    </filter>
    
    <!-- Arrow -->
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#555"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1000" height="1400" fill="#fafbfc"/>

  <!-- Title -->
  <text x="500" y="50" text-anchor="middle" font-family="Arial, sans-serif" font-size="28" font-weight="bold" fill="#2c3e50">
    Activity Diagram — Conversation Flow
  </text>
  <text x="500" y="80" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#7f8c8d">
    ModuBot NAO Controller Interaction Cycle
  </text>

  <!-- ==================== START NODE ==================== -->
  <circle cx="500" cy="140" r="20" fill="#2c3e50"/>
  <text x="500" y="180" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#7f8c8d">Start</text>

  <!-- Arrow: Start → Initialize -->
  <line x1="500" y1="160" x2="500" y2="210" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== INITIALIZE SYSTEM ==================== -->
  <g transform="translate(300, 220)">
    <rect x="0" y="0" width="400" height="60" rx="30" fill="url(#actionGrad)" filter="url(#shadow)"/>
    <text x="200" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white">
      Initialize System
    </text>
  </g>
  <text x="750" y="255" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">Load persona, VAD model,</text>
  <text x="750" y="270" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">action embeddings</text>

  <!-- Arrow: Initialize → Wait -->
  <line x1="500" y1="280" x2="500" y2="340" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== WAIT FOR SPEECH ==================== -->
  <g transform="translate(300, 350)">
    <rect x="0" y="0" width="400" height="60" rx="30" fill="url(#actionGrad)" filter="url(#shadow)"/>
    <text x="200" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white">
      Wait for Speech (VAD)
    </text>
  </g>
  <text x="750" y="385" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">Silero VAD monitors</text>
  <text x="750" y="400" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">microphone input</text>

  <!-- Arrow: Wait → Decision -->
  <line x1="500" y1="410" x2="500" y2="470" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== DECISION: Speech Detected? ==================== -->
  <g transform="translate(410, 480)">
    <polygon points="90,0 180,60 90,120 0,60" fill="url(#decisionGrad)" filter="url(#shadow)"/>
    <text x="90" y="55" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="white">Speech</text>
    <text x="90" y="72" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="white">Detected?</text>
  </g>

  <!-- Arrow: No → Loop back to Wait -->
  <line x1="410" y1="540" x2="200" y2="540" stroke="#555" stroke-width="2"/>
  <line x1="200" y1="540" x2="200" y2="380" stroke="#555" stroke-width="2"/>
  <line x1="200" y1="380" x2="300" y2="380" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="280" y="530" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#e74c3c">[No]</text>

  <!-- Arrow: Yes → Record -->
  <line x1="500" y1="600" x2="500" y2="660" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="520" y="635" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#27ae60">[Yes]</text>

  <!-- ==================== RECORD AUDIO ==================== -->
  <g transform="translate(300, 670)">
    <rect x="0" y="0" width="400" height="60" rx="30" fill="url(#actionGrad)" filter="url(#shadow)"/>
    <text x="200" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white">
      Record Audio
    </text>
  </g>
  <text x="750" y="705" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">Record until 2s silence</text>

  <!-- Arrow: Record → Transcribe -->
  <line x1="500" y1="730" x2="500" y2="790" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== TRANSCRIBE (STT) ==================== -->
  <g transform="translate(300, 800)">
    <rect x="0" y="0" width="400" height="60" rx="30" fill="url(#actionGrad)" filter="url(#shadow)"/>
    <text x="200" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white">
      Transcribe Audio (STT)
    </text>
  </g>
  <text x="750" y="835" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">NVIDIA Riva STT</text>

  <!-- Arrow: Transcribe → Generate -->
  <line x1="500" y1="860" x2="500" y2="920" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== GENERATE RESPONSE (LLM) ==================== -->
  <g transform="translate(300, 930)">
    <rect x="0" y="0" width="400" height="60" rx="30" fill="url(#actionGrad)" filter="url(#shadow)"/>
    <text x="200" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="white">
      Generate Response (LLM)
    </text>
  </g>
  <text x="750" y="955" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">NVIDIA NIM Llama</text>
  <text x="750" y="970" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">Returns: intent | speech</text>

  <!-- Arrow: Generate → Fork -->
  <line x1="500" y1="990" x2="500" y2="1040" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== FORK BAR (Parallel) ==================== -->
  <rect x="250" y="1050" width="500" height="8" rx="4" fill="#2c3e50"/>
  <text x="500" y="1045" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">Fork (Parallel Execution)</text>

  <!-- Fork Lines -->
  <line x1="350" y1="1058" x2="350" y2="1100" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="650" y1="1058" x2="650" y2="1100" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== PARALLEL: TTS ==================== -->
  <g transform="translate(200, 1110)">
    <rect x="0" y="0" width="300" height="60" rx="30" fill="url(#parallelGrad)" filter="url(#shadow)"/>
    <text x="150" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="15" font-weight="bold" fill="white">
      Speak (TTS)
    </text>
  </g>
  <text x="150" y="1150" font-family="Arial, sans-serif" font-size="10" fill="#7f8c8d">NVIDIA Riva TTS</text>

  <!-- ==================== PARALLEL: Action ==================== -->
  <g transform="translate(500, 1110)">
    <rect x="0" y="0" width="300" height="60" rx="30" fill="url(#parallelGrad)" filter="url(#shadow)"/>
    <text x="150" y="38" text-anchor="middle" font-family="Arial, sans-serif" font-size="15" font-weight="bold" fill="white">
      Perform Action
    </text>
  </g>
  <text x="850" y="1150" font-family="Arial, sans-serif" font-size="10" fill="#7f8c8d">Publish to /perform_action</text>

  <!-- Join Lines -->
  <line x1="350" y1="1170" x2="350" y2="1210" stroke="#555" stroke-width="2"/>
  <line x1="650" y1="1170" x2="650" y2="1210" stroke="#555" stroke-width="2"/>

  <!-- ==================== JOIN BAR ==================== -->
  <rect x="250" y="1210" width="500" height="8" rx="4" fill="#2c3e50"/>
  <text x="500" y="1240" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#7f8c8d">Join (Synchronize)</text>

  <!-- Arrow: Join → Loop Decision -->
  <line x1="500" y1="1218" x2="500" y2="1270" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ==================== DECISION: Continue? ==================== -->
  <g transform="translate(410, 1280)">
    <polygon points="90,0 180,50 90,100 0,50" fill="url(#decisionGrad)" filter="url(#shadow)"/>
    <text x="90" y="55" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="white">Continue?</text>
  </g>

  <!-- Arrow: Yes → Loop back -->
  <line x1="410" y1="1330" x2="120" y2="1330" stroke="#555" stroke-width="2"/>
  <line x1="120" y1="1330" x2="120" y2="380" stroke="#555" stroke-width="2"/>
  <line x1="120" y1="380" x2="300" y2="380" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="240" y="1320" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#27ae60">[Yes]</text>

  <!-- Arrow: No → End -->
  <line x1="590" y1="1330" x2="680" y2="1330" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="610" y="1320" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#e74c3c">[No]</text>

  <!-- ==================== END NODE ==================== -->
  <circle cx="720" cy="1330" r="15" fill="white" stroke="#2c3e50" stroke-width="3"/>
  <circle cx="720" cy="1330" r="10" fill="#2c3e50"/>
  <text x="720" y="1365" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#7f8c8d">End</text>

</svg>
